name: sfdx deploy actions

on:
  workflow_call:

jobs:

    run-sfdx-actions:
      runs-on: ubuntu-latest
        if: ${{ github.actor != 'dependabot[bot]' }}
        steps:
            # Now we install nodejs in the VM, and specify version 14
            - uses: actions/deploy-to-salesforce-action@v1
            - name: 'Populat key'
              shell: bash
              run: |
                  echo "${{ secrets.SALESFORCE_JWT_SECRET_KEY }}" > server.key
        
            - name: Setup AUth
              run: sfdx force:auth:jwt:grant --clientid=${{ secrets.SALESFORCE_CONSUMER_KEY }} --jwtkeyfile=server.key --username=${{ secrets.SALESFORCE_DEVHUB_USERNAME }} --setdefaultdevhubusername        
            
            - name: 'Create delta packages for new, modified or deleted metadata'
              run: | 
                  mkdir changed-sources
                  sfdx sgd:source:delta --to "HEAD" --from "HEAD^" --output changed-sources/ --generate-delta --source force-app/
